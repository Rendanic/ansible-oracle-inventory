pipeline {

    parameters {
      string(
        name: 'ANSIBLE_ORACLE_INVENTORY',
        description: 'Subdirectory for Inventory',
        defaultValue: "inventory/dbfs"
      )
      choice(
        name: 'ANSIBLE_HOSTGROUP',
        description: 'Ansible Hostgroup?',
        choices: ['all', 'dbfs', 'tag_db19_3fs', 'tag_db18_latestfs']
      )
      string(
        name: 'ANSIBLE_LIMIT',
        description: 'Ansible --limit <value>?',
        defaultValue: 'all'
      )
      string(
        name: 'ANSIBLE_ORACLE_BRANCH',
        description: 'git clone ansible-oracle branch?',
        defaultValue: "oc"
      )
      string(
        name: 'ANSIBLE_ORACLE_INVENTORY_BRANCH',
        description: 'git clone ansible-oracle-inventory branch?',
        defaultValue: "main"
      )
      // agent-label: label "ecs_ansible_${ANSIBLE_VERSION}"
      choice(
        name: 'ANSIBLE_VERSION',
        description: 'Major Version of Ansible?',
        choices: ['29', '210']
      )
      string(
        name: 'ANSIBLE_USER',
        description: 'User for ansible -u <user>',
        defaultValue: "vagrant"
      )
    }

  agent {
      label "ansible_${ANSIBLE_VERSION}"
  }

  options {
   timeout(time: 180, unit: 'MINUTES')
    disableConcurrentBuilds()
  }

  stages {

    stage('Ansible OS') {

      options {
          timeout(time: 30, unit: 'MINUTES')
      }

      environment {
        ANSIBLE_ROLES_PATH = "${WORKSPACE}/git/ansible-oracle/roles"
        ANSIBLE_LIBRARY = "${WORKSPACE}/git/ansible-oracle/library"
        ANSIBLE_PIPELINING = "True"
        ANSIBLE_DISPLAY_SKIPPED_HOSTS = "False"
      }

      steps {
        dir("git"){
          sh 'rm -rf ansible-oracle'
          sh 'git clone --branch ${ANSIBLE_ORACLE_BRANCH} --single-branch https://github.com/Rendanic/ansible-oracle.git'
        }
        dir("git/ansible-oracle-inventory"){
            git branch: "${ANSIBLE_ORACLE_INVENTORY_BRANCH}", url: 'https://github.com/Rendanic/ansible-oracle-inventory'
          sh 'du -sk ../*'

          ansiblePlaybook(
            playbook: 'os.yml',
            inventory: "${ANSIBLE_ORACLE_INVENTORY}",
            limit: "${ANSIBLE_LIMIT}",
            disableHostKeyChecking: true,
            extras: '-u ${ANSIBLE_USER}',
            extraVars: [
              hostgroup: '${ANSIBLE_HOSTGROUP}'
            ]
          )
        }
      }
    }

    stage('Ansible Restart/GI') {

      options {
          timeout(time: 60, unit: 'MINUTES')
      }

      environment {
        ANSIBLE_ROLES_PATH = "${WORKSPACE}/git/ansible-oracle/roles"
        ANSIBLE_LIBRARY = "${WORKSPACE}/git/ansible-oracle/library"
        ANSIBLE_PIPELINING = "True"
        ANSIBLE_DISPLAY_SKIPPED_HOSTS = "False"
      }

      steps {
        dir("git"){
          sh 'rm -rf ansible-oracle'
          sh 'git clone --branch ${ANSIBLE_ORACLE_BRANCH} --single-branch https://github.com/Rendanic/ansible-oracle.git'
        }
        dir("git/ansible-oracle-inventory"){
            git branch: "${ANSIBLE_ORACLE_CONFIG_BRANCH}", url: 'https://github.com/Rendanic/ansible-oracle-inventory'
          sh 'du -sk ../*'

          ansiblePlaybook(
            playbook: 'swgi.yml',
            inventory: "${ANSIBLE_ORACLE_INVENTORY}",
            limit: "${ANSIBLE_LIMIT}",
            disableHostKeyChecking: true,
            extras: '-u ${ANSIBLE_USER}',
            extraVars: [
              hostgroup: '${ANSIBLE_HOSTGROUP}'
            ]
          )
        }
      }
    }

    stage('Ansible DB') {

      options {
          timeout(time: 45, unit: 'MINUTES')
      }

      environment {
        ANSIBLE_ROLES_PATH = "${WORKSPACE}/git/ansible-oracle/roles"
        ANSIBLE_LIBRARY = "${WORKSPACE}/git/ansible-oracle/library"
        ANSIBLE_PIPELINING = "True"
        ANSIBLE_DISPLAY_SKIPPED_HOSTS = "${ANSIBLE_DISPLAY_SKIPPED_HOSTS}"
      }

      steps {
        sh 'ls -l ${ANSIBLE_CONFIG}'
        dir("git/ansible-oracle-inventory"){
          ansiblePlaybook(
            playbook: 'swdb.yml',
            inventory: "${ANSIBLE_ORACLE_INVENTORY}",
            limit: "${ANSIBLE_LIMIT}",
            disableHostKeyChecking: true,
            extras: '-u ${ANSIBLE_USER}',
            extraVars: [
              hostgroup: '${ANSIBLE_HOSTGROUP}'
            ]
          )
        }
      }
    }

    stage('Ansible DB Management') {

      options {
          timeout(time: 120, unit: 'MINUTES')
      }

      environment {
        ANSIBLE_ROLES_PATH = "${WORKSPACE}/git/ansible-oracle/roles"
        ANSIBLE_LIBRARY = "${WORKSPACE}/git/ansible-oracle/library"
        ANSIBLE_PIPELINING = "True"
        ANSIBLE_DISPLAY_SKIPPED_HOSTS = "${ANSIBLE_DISPLAY_SKIPPED_HOSTS}"
      }

      steps {
        sh 'ls -l ${ANSIBLE_CONFIG}'
        dir("git/ansible-oracle-inventory"){

          ansiblePlaybook(
            playbook: 'manage-db.yml',
            inventory: "${ANSIBLE_ORACLE_INVENTORY}",
            limit: "${ANSIBLE_LIMIT}",
            disableHostKeyChecking: true,
            extras: '-u ${ANSIBLE_USER}',
            extraVars: [
              hostgroup: '${ANSIBLE_HOSTGROUP}'
            ]
          )
        }
      }
    }
  }
}
